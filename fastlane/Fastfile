# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)
platform :ios do

	before_all do
        key_file_path = ENV['API_KEY']
        app_store_connect_api_key(
            key_id: "76GX29C4YY",#API kid
            issuer_id: "7a9803b0-51d8-44c5-ba26-f916da982cbe",#Issuer ID
            key_filepath: key_file_path,
            duration: 1200, 
            in_house: false, 
        )
	end


	lane :buildIpa  do |options|
		update_info_plist(plist_path: "ktobet-asia-ios/info.plist", 
				  block: proc do |plist|
					#version = plist["CFBundleVersion"].to_i + 1
    					#plist["CFBundleVersion"]  = "#{version}.0"
					plist["CFBundleVersion"]  = options[:buildVersion]
					plist["CFBundleShortVersionString"] = options[:appVersion]
  				  end)
  		build_app(scheme: "ktobet-asia-ios",
			  workspace: "ktobet-asia-ios.xcworkspace",
            		  include_bitcode: true,
			  clean: true,
		   	  output_directory: "output",
			  export_method: "ad-hoc",
	    		  export_options: { 
					    method: "ad-hoc",
					  }
			 )

	end


	lane :buildIpaQat  do |options|

		match(type: "adhoc", keychain_name: "jenkinsKeyChain", keychain_password: "password")
		update_info_plist(plist_path: "ktobet-asia-ios/ktobet-asia-ios-qat-Info.plist", 
				  block: proc do |plist|
					#version = plist["CFBundleVersion"].to_i + 1
    					#plist["CFBundleVersion"]  = "#{version}.0"
					plist["CFBundleVersion"]  = options[:buildVersion]
					plist["CFBundleShortVersionString"] = options[:appVersion]
  				  end)
  		build_app(scheme: "ktobet-asia-ios-qat",
			  workspace: "ktobet-asia-ios.xcworkspace",
            		  include_bitcode: true,
			  clean: true,
		   	  output_directory: "output",
			  export_method: "ad-hoc",
	    		  export_options: { 
					    method: "ad-hoc",
					  }
			 )

	end

	lane :buildIpaQatv  do |options|

		match(type: "adhoc", keychain_name: "jenkinsKeyChain", keychain_password: "password")
		update_info_plist(plist_path: "ktobet-asia-ios/ktobet-asia-ios-qat-v-Info.plist", 
				  block: proc do |plist|
					#version = plist["CFBundleVersion"].to_i + 1
    					#plist["CFBundleVersion"]  = "#{version}.0"
					plist["CFBundleVersion"]  = options[:buildVersion]
					plist["CFBundleShortVersionString"] = options[:appVersion]
  				  end)
  		build_app(scheme: "ktobet-asia-ios-qatv",
			  workspace: "ktobet-asia-ios.xcworkspace",
            		  include_bitcode: true,
			  clean: true,
		   	  output_directory: "output",
			  export_method: "ad-hoc",
	    		  export_options: { 
					    method: "ad-hoc",
					  }
			 )

	end

	lane :buildIpaStaging  do |options|

		match(type: "appstore", keychain_name: "jenkinsKeyChain", keychain_password: "password")
		update_info_plist(plist_path: "ktobet-asia-ios/ktobet-asia-ios-staging-Info.plist", 
				  block: proc do |plist|
					#version = plist["CFBundleVersion"].to_i + 1
    					#plist["CFBundleVersion"]  = "#{version}.0"
					plist["CFBundleVersion"]  = options[:buildVersion]
					plist["CFBundleShortVersionString"] = options[:appVersion]
  				  end)
  		build_app(scheme: "ktobet-asia-ios-staging",
			  workspace: "ktobet-asia-ios.xcworkspace",
            		  include_bitcode: true,
			  clean: true,
		   	  output_directory: "output",
			  export_method: "app-store",
	    		  export_options: { 
					    method: "app-store",
					  }
			 )

	end


	lane :uploadstagingToTestflight do |options|

		
		match(type: "appstore", keychain_name: "jenkinsKeyChain", keychain_password: "password")
		update_info_plist(plist_path: "ktobet-asia-ios/ktobet-asia-ios-staging-Info.plist", 
				  block: proc do |plist|
					#version = plist["CFBundleVersion"].to_i + 1
    					#plist["CFBundleVersion"]  = "#{version}.0"
					plist["CFBundleVersion"]  = options[:buildVersion]
					plist["CFBundleShortVersionString"] = options[:appVersion]
  				  end)

    		gym(	configuration: "Release",
      		     	scheme: "ktobet-asia-ios-staging",
      		     	clean: true,
      		     	include_bitcode: true,
      			include_symbols: true,
      			export_method: 'app-store',
      			export_xcargs: "-allowProvisioningUpdates")
      			#export_options: { provisioningProfiles: {"com.higgstar.ktoasiabet.staging" => "kto_asia_appstore"}})

    		upload_to_testflight(   skip_waiting_for_build_processing: true,
					username: "higgs-mobile@hotmail.com",
  					app_identifier: "com.higgstar.ktoasiabet.staging")
	end



	lane :uploadToTestflight do |options|

		
		match(type: "appstore", keychain_name: "jenkinsKeyChain", keychain_password: "password")
		update_info_plist(plist_path: "ktobet-asia-ios/ktobet-asia-ios-qat-Info.plist", 
				  block: proc do |plist|
					#version = plist["CFBundleVersion"].to_i + 1
    					#plist["CFBundleVersion"]  = "#{version}.0"
					plist["CFBundleVersion"]  = options[:buildVersion]
					plist["CFBundleShortVersionString"] = options[:appVersion]
  				  end)

    		gym(	configuration: "Release",
      		     	scheme: "ktobet-asia-ios-qat",
      		     	clean: true,
      		     	include_bitcode: true,
      			include_symbols: true,
      			export_method: 'app-store',
      			export_xcargs: "-allowProvisioningUpdates")
      			#export_options: { provisioningProfiles: {"com.higgstar.ktoasiabet" => "kto_asia_adhoc"}})

    		upload_to_testflight(   username: "higgs-mobile@hotmail.com",
  					app_identifier: "com.higgstar.ktoasiabet")
	end

	lane :uploadqatvToTestflight do |options|

		
		match(type: "appstore", keychain_name: "jenkinsKeyChain", keychain_password: "password")
		update_info_plist(plist_path: "ktobet-asia-ios/ktobet-asia-ios-qat-v-Info.plist", 
				  block: proc do |plist|
					#version = plist["CFBundleVersion"].to_i + 1
    					#plist["CFBundleVersion"]  = "#{version}.0"
					plist["CFBundleVersion"]  = options[:buildVersion]
					plist["CFBundleShortVersionString"] = options[:appVersion]
  				  end)

    		gym(	configuration: "Release",
      		     	scheme: "ktobet-asia-ios-qatv",
      		     	clean: true,
      		     	include_bitcode: true,
      			include_symbols: true,
      			export_method: 'app-store',
      			export_xcargs: "-allowProvisioningUpdates")
      			#export_options: { provisioningProfiles: {"com.higgstar.ktoasiabet.qatv" => "kto_asia_adhoc"}})

    		upload_to_testflight(   username: "higgs-mobile@hotmail.com",
  					app_identifier: "com.higgstar.ktoasiabet.qatv")
	end




end
